<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Independent Orbital Ribbons</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/addons/p5.sound.min.js"></script>
  <style>
    body { margin: 0; background: black; overflow: hidden; }
    canvas { display: block; }
    #start {
      position: absolute;
      top: 20px;
      left: 20px;
      padding: 10px 20px;
      font-size: 16px;
      background: #f2f2f2;
      color: black;
      border: none;
      cursor: pointer;
      z-index: 10;
    }
  </style>
</head>
<body>
<button id="start">Start Audio</button>
<script>
let t = 0;
let baseRadius;
let trails = [[], [], []];
let ribbonConfigs = [];
let rot = { x: 0, y: 0, z: 0 };

let sound, fft, amplitude;
let started = false;
let energy = { bass: 0, mid: 0, treble: 0 };

function preload() {
  sound = loadSound('audio/second sight.wav');
}

function setup() {
  createCanvas(windowWidth, windowHeight, WEBGL);
  noFill();
  baseRadius = min(windowWidth, windowHeight) * 0.3;

  fft = new p5.FFT();
  amplitude = new p5.Amplitude();

  // Create independent orbital shapes for each ribbon
  for (let i = 0; i < 3; i++) {
    ribbonConfigs.push({
      offset: i * 1.5,
      loopX: baseRadius * random(0.8, 1.3),
      loopY: baseRadius * random(0.6, 1.2),
      loopZ: baseRadius * random(0.7, 1.1),
    });
  }

  document.getElementById('start').onclick = () => {
    if (!started) {
      userStartAudio().then(() => {
        sound.play();
        started = true;
        document.getElementById('start').style.display = 'none';
      });
    }
  };
}

function draw() {
  background(0);

  if (started) {
    fft.analyze();
    energy.bass = lerp(energy.bass, fft.getEnergy("bass"), 0.05);
    energy.mid = lerp(energy.mid, fft.getEnergy("mid"), 0.05);
    energy.treble = lerp(energy.treble, fft.getEnergy("treble"), 0.05);
  }

  rotateX(rot.x);
  rotateY(rot.y);
  rotateZ(rot.z);

  const col = [242, 242, 242];

  renderRibbon(trails[0], t + ribbonConfigs[0].offset, ribbonConfigs[0], energy.bass, col);
  renderRibbon(trails[1], -t + ribbonConfigs[1].offset, ribbonConfigs[1], energy.mid, col);
  renderRibbon(trails[2], t + ribbonConfigs[2].offset, ribbonConfigs[2], energy.treble, col);

  t = (t + 0.02) % TWO_PI;

  rot.x += 0.003;
  rot.y += 0.002;
  rot.z += 0.0015;
}

function renderRibbon(trails, localT, config, bandEnergy, baseColor) {
  const { loopX, loopY, loopZ } = config;

  const p1 = {
    x: loopX * cos(localT),
    y: loopY * sin(localT),
    z: loopZ * sin(localT * 2)
  };

  const p2 = {
    x: loopX * cos(localT + PI / 2),
    y: loopY * sin(localT + PI / 2),
    z: loopZ * sin((localT + PI / 2) * 2)
  };

  let mx = (p1.x + p2.x) / 2;
  let my = (p1.y + p2.y) / 2;
  let mz = (p1.z + p2.z) / 2;

  let dx = p2.y - p1.y;
  let dy = -(p2.x - p1.x);
  let dz = sin(localT) * 30;
  let len = sqrt(dx * dx + dy * dy + dz * dz);
  dx /= len; dy /= len; dz /= len;

  const bend = map(bandEnergy, 0, 255, 50, 120);
  mx += dx * bend;
  my += dy * bend;
  mz += dz * 20;

  trails.push({ p1, p2, m: { x: mx, y: my, z: mz } });
  if (trails.length > 80) trails.shift();

  stroke(baseColor[0], baseColor[1], baseColor[2], 200);
  for (let i = 0; i < trails.length; i++) {
    const { p1, p2, m } = trails[i];
    const alpha = map(i, 0, trails.length, 10, 255);
    const weight = map(i, 0, trails.length, 0.5, 1.8);
    strokeWeight(weight);
    stroke(baseColor[0], baseColor[1], baseColor[2], alpha);
    beginShape();
    vertex(p1.x, p1.y, p1.z);
    quadraticVertex(m.x, m.y, m.z, p2.x, p2.y, p2.z);
    endShape();
  }
}

function keyPressed() {
  if (key === ' ') {
    let timestamp = floor(sound.currentTime());
    let minutes = floor(timestamp / 60);
    let seconds = timestamp % 60;
    let filename = `itero-${minutes}-${seconds}.png`;
    saveCanvas(filename, 'png');
  }
}

</script>
</body>
</html>
